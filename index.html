<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="">
    <style>
      header {
        margin-bottom: 5%;
        background-color: #333;
        width: 100%;
        text-align: center;
        color: #fff;
        z-index: 10;
      }

      main {
        display: flex;
        flex-direction: column;
        margin-left: 25%;
      }

      .side-nav {
        height: 100%;
        width: 25%;
        position: fixed;
        z-index: -2;
        top: 0;
        left: 0;
        background-color: rgba(238, 238, 238, 0.6);
        overflow-x: hidden;
        transition: 0.5s;
        padding-top: 60px;
      }

    </style>
  </head>
  <body>

    <header>
      <h1>Weather Dashboard</h1>
    </header>

    <main>

      <section class="side-nav col-sm-12 col-md-4">
        <h4>Search for a City:</h4>

        <form>
          <input type="text" id="form-input" />
          <button type="submit" value="" class="btn btn-primary"><i class="bi bi-search"></i></button>
        </form>
        
        <div class="card" style="width: 14rem;">
          <ul id="cities-search-history" class="list-group list-group-flush">
            <li class="list-group-item">Chicago</li>
            <li class="list-group-item">San Francisco</li>
            <li class="list-group-item">New York</li>
          </ul>
        </div>
        <button class="btn btn-primary" onclick="handleLocalStorage('clear', 'searchHistory')">Clear History</button>

      </section>

      <section id="weather-details" class="col-sm-12 col-md-12">
        <div class="card">
          <div class="card-body">
            <h1 class="display-4 card-title">Atlanta (8/15/2021) <i class="bi bi-search"></i></h1>
            <p class="lead">Temperature: 90.9 F</p>
            <p class="card-subtitle mb-2">Humidity: 41%</p>
            <p class="card-text">Wind Speed: 4.7 MPH</p>
            <p class="card-text">UV Index: 9.49</p>
          </div>
        </div>
      </section>

      <div class="container">
        <h3>5-Day Forecast:</h3>
        <section id="5-day" class="row center">
          <div class="card text-white bg-primary mb-3" style="width: 8rem; margin: 2%;">
            <div class="card-body">
              <h5 class="card-title">8/15/21</h5>
              <img class="card-img-top" src="..." alt="Card image cap">
              <p class="card-subtitle mb-2 text-muted">Temp: 86.84 F</p>
              <p class="card-text">Humidity: 33%</p>
            </div>
          </div>
          <div class="card text-white bg-primary mb-3" style="width: 8rem; margin: 2%;">
            <div class="card-body">
              <h5 class="card-title">8/15/21</h5>
              <img class="card-img-top" src="..." alt="Card image cap">
              <p class="card-subtitle mb-2 text-muted">Temp: 86.84 F</p>
              <p class="card-text">Humidity: 33%</p>
            </div>
          </div>
          <div class="card text-white bg-primary mb-3" style="width: 8rem; margin: 2%;">
            <div class="card-body">
              <h5 class="card-title">8/15/21</h5>
              <img class="card-img-top" src="..." alt="Card image cap">
              <p class="card-subtitle mb-2 text-muted">Temp: 86.84 F</p>
              <p class="card-text">Humidity: 33%</p>
            </div>
          </div>
          <div class="card text-white bg-primary mb-3" style="width: 8rem; margin: 2%;">
            <div class="card-body">
              <h5 class="card-title">8/15/21</h5>
              <img class="card-img-top" src="..." alt="Card image cap">
              <p class="card-subtitle mb-2 text-muted">Temp: 86.84 F</p>
              <p class="card-text">Humidity: 33%</p>
            </div>
          </div>
          <div class="card text-white bg-primary mb-3" style="width: 8rem; margin: 2%;">
            <div class="card-body">
              <h5 class="card-title">8/15/21</h5>
              <img class="card-img-top" src="..." alt="Card image cap">
              <p class="card-subtitle mb-2 text-muted">Temp: 86.84 F</p>
              <p class="card-text">Humidity: 33%</p>
            </div>
          </div>
        </section>
      </div>

    </main>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <script>
      const form = document.querySelector("form")
      const formInput = document.querySelector("#form-input")
      const weatherCardsContainer = document.getElementById("5-day");
      const searchHistoryList = document.querySelector("ul")

      let weatherData;
      let setIsFetching = false;

      //handle local storage function for encapsulating the CRUD operations to be called in a clean way anywhere throughout our app. Also perfect solution to handle multiple local storage's.
      const handleLocalStorage = (action, storageName, data) => {
        switch (action) {//CRUD
          case "initialize" ://Read
            const storage = localStorage.getItem(storageName) ? 
            JSON.parse(localStorage.getItem(storageName)) : []
            return storage;
            break;
          case "set" ://Create/Update
            localStorage.setItem(storageName, JSON.stringify(data));
            break;
          case "get" ://Read
            //code
            break;
          case "clear" ://Delete
            localStorage.clear(storageName)
            setCityHistoryList()
            break;
          default:
            null
        }
      }

      //function to handle fetch
      const handleFetch = async (city) => {

        function unUsedAPICredentials() {
          //RapidAPI headers and URL
          const headers = {
            key: "ac72153c36mshd1814c8f1af20f3p1518fbjsnabee85184908",
            host: "community-open-weather-map.p.rapidapi.com"
          }
          const url = `https://community-open-weather-map.p.rapidapi.com/forecast?q=${city}`;
        }
        console.info(city)

        const APIKEY = "7d56f33a468c2d6fc63233a09c84c8dc"
        const dynamicUrl = `api.openweathermap.org/data/2.5/forecast/daily?q=${city}&mode=xml&units=metric&cnt=7&appid=${APIKEY}`;

        const url = 'http://api.openweathermap.org/data/2.5/forecast?id=524901&appid=7d56f33a468c2d6fc63233a09c84c8dc'

        setIsFetching = true;

        await fetch(url)
          .then(response => response.json())
          .then(data => {
            console.info(data)
            weatherData = data;
            setIsFetching = false;
          })
          .catch(exception => {
            console.error(exception);
            setIsFetching = false;
          });
      }
      
      //set initialized storage array to variable
      const storage = handleLocalStorage("initialize", "searchHistory");
      const lastSearchedIndex = storage.length

      //function that handles updating the search history list to the DOM.
      const setCityHistoryList = (storage) => {
        const updatedStorage = handleLocalStorage("get", "searchHistory")
        let data = updatedStorage ? updatedStorage : storage;
        data && console.info(data, searchHistoryList, data.length)
        searchHistoryList.innerHTML = `
        ${data.map(history => 
          `<li class="list-group-item">${history.city}</li>`
          ).join("")}
          `
        }
        
      setCityHistoryList(storage)
        
      const setWeatherCards = (forecast) => {

        function convertTemp(temp) {
          const farenheit = ( (temp *  9/5) - 459.67 );
          return farenheit;
        }
        
        //const farenheit = Math.round(convertTemp(forecast.main.temp));
        //const feelsLikeF = Math.round(convertTemp(forecast.main.feels_like));

        const iconUrl = "http://openweathermap.org/img/w/" + forecast.weather[0].icon + ".png";
        console.info(iconUrl)


        weatherCardsContainer.innerHTML = `
        <!-- <h2>5-Day Forecast:</h2> -->
        ${forecast.map(day => `
          <div class="card text-white bg-primary mb-3" style="width: 8rem; margin: 2%;">
            <div class="card-body">
              <h5 class="card-title">${day.dt_txt}</h5>
              <img class="card-img-top" src=${iconUrl} alt="Weather icon.">
              <p class="card-subtitle mb-2 text-muted"> ${day.main.temp}</p>
              <p class="card-text"> ${day.weather[0].description}</p>
            </div>
          </div>
          `).join("")}
        `
      }      

      const convertToFiveDay = () => {
        console.info(weatherData);
        const forecast = []; //set empty array to hold 5 days worth of forecast data

        if (weatherData) {
          try {
            // to format the data structure to be strictly a 5-day forecast, we'll use this "for loop" to divide the 40 "3-hour" record lines by 8. Which will return just 5 days worth of data then.
            for (let i = 0; i < 40; i += 8) {
              // We'll then need to append this newly formated data structure to an empty array variable to then later set in state.
              forecast.push(weatherData.list[i]);
            }
            
          } catch (exception) {
            console.error(exception); //handle any errors
          }
        } else { alert("Something is Wrong!") }

        return forecast;
      }

      //funciton that contains the logic to set the city and get the weather
      const handleSubmit = async (event) => {
        event.preventDefault();

        //push the captured form input to the storage
        storage.push({ city: formInput.value });
        //set the storage using our vanilla handleLocalStorage hook
        handleLocalStorage("set", "searchHistory", storage);
        //get weather data from API passing in the city
        const data = handleFetch(formInput.value)

        //converts the data into a 5-day forecast
        //const forecast = convertToFiveDay(data);
        //forecast containing the 5day forecast
        console.info(forecast, weatherData);
        //sets weather in the DOM using the formatted forecast.
        setWeatherCards(forecast);
        //update the city search history list
        setCityHistoryList()

        const city = storage[lastSearchedIndex - 1].city ? storage[lastSearchedIndex - 1].city : "chicago"
      }

      form.addEventListener("submit", (event) => handleSubmit(event))
    </script>
  </body>
</html>